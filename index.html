<script type="module">
(async () => {
  const crash = (title, details) => {
    document.body.innerHTML = `
      <div style="padding:18px;font-family:ui-monospace,Menlo,Consolas,monospace;color:#b00020;">
        <h2 style="margin:0 0 10px 0;">${title}</h2>
        <pre style="white-space:pre-wrap;margin:0;">${details}</pre>
      </div>
    `;
  };

  try {
    // Wait until DOM exists (fixes script-running-too-early)
    if (document.readyState === "loading") {
      await new Promise(r => document.addEventListener("DOMContentLoaded", r, { once:true }));
    }

    // Simple ID checker
    const $ = (id) => document.getElementById(id);
    const must = ["login","portal","content","email","password","loginBtn","logoutBtn"];

    const missing = must.filter(id => !$(id));
    if (missing.length) {
      // Show what we DO have, so we can match it fast
      const found = must.filter(id => $(id)).join(", ") || "none";
      crash(
        "Portal Crash: HTML ID mismatch",
        `Missing required IDs:\n- ${missing.join("\n- ")}\n\nFound from required set:\n- ${found}\n\nFix: your HTML must contain these exact IDs.\n(login, portal, content, email, password, loginBtn, logoutBtn)\n\nTip: Search in index.html for id="loginBtn" etc.`
      );
      return;
    }

    // Now import Supabase
    let createClient;
    try {
      ({ createClient } = await import("https://esm.sh/@supabase/supabase-js@2"));
    } catch (e) {
      crash(
        "Portal Crash: Supabase import failed",
        String(e && (e.stack || e.message || e))
      );
      return;
    }

    const supabase = createClient(
      "https://lnevuelwsiewxdrmgckh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuZXZ1ZWx3c2lld3hkcm1nY2toIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzMyNjgsImV4cCI6MjA4NjMwOTI2OH0.voDpAvnscFh9-e70-xV4UBxtcO-TwYbU6V0JRPUFFIs"
    );

    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));

    const debug = (msg) => {
      const el = $("debug");
      if (el) el.textContent = msg;
      console.log("[PORTAL]", msg);
    };

    debug("JS loaded ‚úÖ");

    const login = $("login");
    const portal = $("portal");
    const content = $("content");
    const email = $("email");
    const password = $("password");
    const loginBtn = $("loginBtn");
    const logoutBtn = $("logoutBtn");
    const loginError = $("loginError");
    const userEmail = $("userEmail");

    // Optional nav
    const schedBtn = $("schedBtn");
    const apprBtn = $("apprBtn");
    const usersBtn = $("usersBtn");

    let CURRENT_USER = null;
    let IS_ADMIN = false;
    let MY_CREDS = { role: null };

    function setActiveNav(btn){
      [schedBtn, apprBtn, usersBtn].filter(Boolean).forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    }

    async function getUser() {
      const { data } = await supabase.auth.getSession();
      return data?.session?.user || null;
    }

    async function checkAdmin(userId) {
      const { data, error } = await supabase
        .from("user_roles")
        .select("is_admin")
        .eq("user_id", userId)
        .maybeSingle();
      if (error) return false;
      return !!data?.is_admin;
    }

    async function loadMyCreds(userId) {
      const { data } = await supabase
        .from("user_roles")
        .select("role")
        .eq("user_id", userId)
        .maybeSingle();
      return { role: data?.role ?? null };
    }

    function fmtDT(dt) {
      if (!dt) return "";
      try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
    }

    function renderNotesBox(notes) {
      const n = (notes || "").trim();
      if (!n) return "";
      return `
        <div class="noteBox">
          <div class="noteTitle">Notes</div>
          <div>${esc(n).replace(/\n/g,"<br>")}</div>
        </div>
      `;
    }

    function renderLinkRow(mapUrl, directionsUrl) {
      const a = [];
      const map = (mapUrl || "").trim();
      const dir = (directionsUrl || "").trim();
      if (map) a.push(`<a href="${esc(map)}" target="_blank" rel="noopener">üó∫Ô∏è Event Map</a>`);
      if (dir) a.push(`<a href="${esc(dir)}" target="_blank" rel="noopener">üß≠ Directions</a>`);
      if (!a.length) return "";
      return `<div class="linkRow">${a.join("")}</div>`;
    }

    function canUserClaimShift(s) {
      if (s.required_role) {
        const need = String(s.required_role).trim().toLowerCase();
        const have = String(MY_CREDS.role || "").trim().toLowerCase();
        if (!have || have !== need) return { ok:false, reason:`Requires ${s.required_role}` };
      }
      return { ok:true, reason:"" };
    }

    async function getApprovedCountsForShiftIds(shiftIds) {
      const map = {};
      shiftIds.forEach(id => map[id] = 0);
      if (!shiftIds.length) return map;

      const { data } = await supabase
        .from("shift_claims")
        .select("shift_id")
        .in("shift_id", shiftIds)
        .eq("status", "approved");

      (data || []).forEach(r => map[r.shift_id] = (map[r.shift_id] || 0) + 1);
      return map;
    }

    async function getMyClaimStatusMapForShiftIds(shiftIds) {
      const map = {};
      if (!shiftIds.length) return map;

      const { data } = await supabase
        .from("shift_claims")
        .select("shift_id,status")
        .in("shift_id", shiftIds)
        .eq("user_id", CURRENT_USER.id)
        .in("status", ["pending","approved","removal_requested"]);

      (data || []).forEach(r => { map[r.shift_id] = r.status; });
      return map;
    }

    function slotsText(approvedCount, crewSize) {
      const cs = Math.max(1, Number(crewSize || 1));
      const ac = Number(approvedCount || 0);
      return `${ac}/${cs} filled`;
    }

    // ---- Auth buttons ----
    loginBtn.onclick = async () => {
      if (loginError) loginError.textContent = "";
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value,
        password: password.value
      });
      if (error) {
        if (loginError) loginError.textContent = error.message;
        return;
      }
      await showPortal(data.user);
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    async function showPortal(user) {
      CURRENT_USER = user;
      IS_ADMIN = await checkAdmin(user.id);
      MY_CREDS = await loadMyCreds(user.id);

      login.classList.add("hidden");
      portal.classList.remove("hidden");
      if (userEmail) userEmail.textContent = user.email;

      if (apprBtn) apprBtn.style.display = IS_ADMIN ? "inline-block" : "none";
      if (usersBtn) usersBtn.style.display = IS_ADMIN ? "inline-block" : "none";

      await showSchedule();
    }

    async function showSchedule() {
      if (schedBtn) setActiveNav(schedBtn);

      content.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <h3>Scheduling</h3>
            <div class="small">Claim shifts for approval.</div>
            <div class="small" style="margin-top:6px;">Your role: <b>${esc(MY_CREDS.role || "Not set")}</b></div>
          </div>
          <span class="pill blue">${IS_ADMIN ? "Admin" : "Employee"}</span>
        </div>
        <div id="list" style="margin-top:14px; display:grid; gap:12px;"></div>
      `;
      await loadShifts();
    }

    async function loadShifts() {
      const list = $("list");
      if (!list) return;

      const { data, error } = await supabase
        .from("shifts")
        .select("*")
        .order("start_time", { ascending: true });

      if (error) {
        list.innerHTML = `<div class="error">${esc(error.message)}</div>`;
        return;
      }

      const shifts = data || [];
      const shiftIds = shifts.map(s => s.id);

      const approvedCounts = await getApprovedCountsForShiftIds(shiftIds);
      const myStatus = CURRENT_USER ? await getMyClaimStatusMapForShiftIds(shiftIds) : {};

      list.innerHTML = shifts.map(s => {
        const cs = Math.max(1, Number(s.crew_size || 1));
        const ac = Number(approvedCounts[s.id] || 0);
        const full = ac >= cs;

        const mine = myStatus[s.id];
        const gate = canUserClaimShift(s);

        let claimBtnHtml = "";
        if (full) claimBtnHtml = `<span class="pill">Filled</span>`;
        else if (mine === "pending") claimBtnHtml = `<span class="pill blue">Pending</span>`;
        else if (mine === "approved") claimBtnHtml = `<span class="pill ok">Approved</span>`;
        else if (!gate.ok) claimBtnHtml = `<button disabled>Claim</button><div class="small" style="margin-top:6px;">${esc(gate.reason)}</div>`;
        else claimBtnHtml = `<button onclick="claimShift('${s.id}')">Claim</button>`;

        return `
          <div class="card">
            <div style="font-weight:1000;">${esc(s.title)}</div>
            <div class="small" style="margin-top:6px;">üïí ${fmtDT(s.start_time)}${s.end_time ? ` ‚Äì ${fmtDT(s.end_time)}` : ""}</div>
            ${renderLinkRow(s.google_map_url, s.directions_url)}
            ${renderNotesBox(s.notes)}
            <div style="margin-top:10px;">
              <span class="pill">${slotsText(ac, cs)}</span>
              <span style="margin-left:8px;">${claimBtnHtml}</span>
            </div>
          </div>
        `;
      }).join("") || `<div class="pill">No shifts posted yet</div>`;
    }

    window.claimShift = async (shiftId) => {
      if (!CURRENT_USER) return alert("Log in first.");

      const { data: shift, error: sErr } = await supabase
        .from("shifts")
        .select("id,crew_size,required_role")
        .eq("id", shiftId)
        .single();
      if (sErr) return alert(sErr.message);

      const gate = canUserClaimShift(shift);
      if (!gate.ok) return alert("Cannot claim: " + gate.reason);

      const { error } = await supabase.from("shift_claims").insert({
        shift_id: shiftId,
        user_id: CURRENT_USER.id,
        user_email: CURRENT_USER.email,
        status: "pending"
      });
      if (error) return alert(error.message);

      alert("Claim sent ‚úÖ");
      await loadShifts();
    };

    if (schedBtn) schedBtn.onclick = showSchedule;

    const user = await getUser();
    if (user) await showPortal(user);

  } catch (err) {
    crash("Portal Crash", String(err && (err.stack || err.message || err)));
  }
})();
</script>