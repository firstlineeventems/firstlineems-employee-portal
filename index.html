<script type="module">
(async () => {
  try {
    const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");

    const supabase = createClient(
      "https://lnevuelwsiewxdrmgckh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuZXZ1ZWx3c2lld3hkcm1nY2toIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzMyNjgsImV4cCI6MjA4NjMwOTI2OH0.voDpAvnscFh9-e70-xV4UBxtcO-TwYbU6V0JRPUFFIs"
    );

    const $ = (id) => document.getElementById(id);

    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));

    const debug = (msg) => {
      const el = $("debug");
      if (el) el.textContent = msg;
      console.log("[PORTAL]", msg);
    };

    debug("JS loaded ‚úÖ");

    // ---- Grab ONLY the truly required elements ----
    const login = $("login");
    const portal = $("portal");
    const content = $("content");

    const email = $("email");
    const password = $("password");
    const loginBtn = $("loginBtn");
    const logoutBtn = $("logoutBtn");

    const loginError = $("loginError");
    const userEmail = $("userEmail");

    if (!login || !portal || !content) throw new Error("Missing #login, #portal, or #content in HTML.");
    if (!email || !password || !loginBtn) throw new Error("Missing #email, #password, or #loginBtn in HTML.");
    if (!logoutBtn) throw new Error("Missing #logoutBtn in HTML.");

    // Optional nav buttons (won't crash if missing)
    const schedBtn = $("schedBtn");
    const calBtn = $("calBtn");
    const myBtn = $("myBtn");
    const annBtn = $("annBtn");
    const apprBtn = $("apprBtn");
    const usersBtn = $("usersBtn");

    let CURRENT_USER = null;
    let IS_ADMIN = false;
    let MY_CREDS = { role: null };

    function setActiveNav(btn){
      [schedBtn, calBtn, myBtn, annBtn, apprBtn, usersBtn].filter(Boolean)
        .forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    }

    async function getUser() {
      const { data } = await supabase.auth.getSession();
      return data?.session?.user || null;
    }

    async function checkAdmin(userId) {
      const { data, error } = await supabase
        .from("user_roles")
        .select("is_admin")
        .eq("user_id", userId)
        .maybeSingle();
      if (error) return false;
      return !!data?.is_admin;
    }

    async function loadMyCreds(userId) {
      const { data } = await supabase
        .from("user_roles")
        .select("role")
        .eq("user_id", userId)
        .maybeSingle();
      return { role: data?.role ?? null };
    }

    function fmtDT(dt) {
      if (!dt) return "";
      try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
    }

    function renderNotesBox(notes) {
      const n = (notes || "").trim();
      if (!n) return "";
      return `
        <div class="noteBox">
          <div class="noteTitle">Notes</div>
          <div>${esc(n).replace(/\n/g,"<br>")}</div>
        </div>
      `;
    }

    function renderLinkRow(mapUrl, directionsUrl) {
      const a = [];
      const map = (mapUrl || "").trim();
      const dir = (directionsUrl || "").trim();
      if (map) a.push(`<a href="${esc(map)}" target="_blank" rel="noopener">üó∫Ô∏è Event Map</a>`);
      if (dir) a.push(`<a href="${esc(dir)}" target="_blank" rel="noopener">üß≠ Directions</a>`);
      if (!a.length) return "";
      return `<div class="linkRow">${a.join("")}</div>`;
    }

    function reqPills(s) {
      const pills = [];
      if (s.required_role) pills.push(`<span class="pill warn">Req: ${esc(s.required_role)}</span>`);
      return pills.length ? `<div class="row" style="margin-top:10px;">${pills.join("")}</div>` : "";
    }

    function canUserClaimShift(s) {
      if (s.required_role) {
        const need = String(s.required_role).trim().toLowerCase();
        const have = String(MY_CREDS.role || "").trim().toLowerCase();
        if (!have || have !== need) return { ok:false, reason:`Requires ${s.required_role}` };
      }
      return { ok:true, reason:"" };
    }

    async function getApprovedCountsForShiftIds(shiftIds) {
      const map = {};
      shiftIds.forEach(id => map[id] = 0);
      if (!shiftIds.length) return map;

      const { data } = await supabase
        .from("shift_claims")
        .select("shift_id")
        .in("shift_id", shiftIds)
        .eq("status", "approved");

      (data || []).forEach(r => map[r.shift_id] = (map[r.shift_id] || 0) + 1);
      return map;
    }

    async function getMyClaimStatusMapForShiftIds(shiftIds) {
      const map = {};
      if (!shiftIds.length) return map;

      const { data } = await supabase
        .from("shift_claims")
        .select("shift_id,status")
        .in("shift_id", shiftIds)
        .eq("user_id", CURRENT_USER.id)
        .in("status", ["pending","approved","removal_requested"]);

      (data || []).forEach(r => { map[r.shift_id] = r.status; });
      return map;
    }

    function slotsText(approvedCount, crewSize) {
      const cs = Math.max(1, Number(crewSize || 1));
      const ac = Number(approvedCount || 0);
      return `${ac}/${cs} filled`;
    }

    // ===== auth =====
    loginBtn.onclick = async () => {
      if (loginError) loginError.textContent = "";
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value,
        password: password.value
      });
      if (error) {
        if (loginError) loginError.textContent = error.message;
        return;
      }
      await showPortal(data.user);
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    async function showPortal(user) {
      CURRENT_USER = user;
      IS_ADMIN = await checkAdmin(user.id);
      MY_CREDS = await loadMyCreds(user.id);

      login.classList.add("hidden");
      portal.classList.remove("hidden");
      if (userEmail) userEmail.textContent = user.email;

      if (apprBtn) apprBtn.style.display = IS_ADMIN ? "inline-block" : "none";
      if (usersBtn) usersBtn.style.display = IS_ADMIN ? "inline-block" : "none";

      await showSchedule();
    }

    // ===== schedule =====
    async function showSchedule() {
      if (schedBtn) setActiveNav(schedBtn);

      content.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <h3>Scheduling</h3>
            <div class="small">Claim shifts for approval. Approved shifts appear in ‚ÄúMy Requests / Shifts‚Äù.</div>
            <div class="small" style="margin-top:6px;">Your role: <b>${esc(MY_CREDS.role || "Not set")}</b></div>
          </div>
          <span class="pill blue">${IS_ADMIN ? "Admin" : "Employee"}</span>
        </div>

        ${IS_ADMIN ? `
        <div class="card sectionCard">
          <h4>Post Shift</h4>

          <div class="grid5">
            <div><label>Title</label><input id="stitle" style="width:100%;" /></div>
            <div><label>Start</label><input id="sstart" type="datetime-local" style="width:100%;" /></div>
            <div><label>End</label><input id="send" type="datetime-local" style="width:100%;" /></div>
            <div><label>Where</label><input id="swhere" style="width:100%;" /></div>
            <div><label>Crew Size</label><input id="screw" type="number" min="1" value="1" style="width:100%;" /></div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div style="flex:1; min-width:240px;">
              <label>Required Role (optional)</label>
              <select id="srole" style="width:100%;">
                <option value="">None</option>
                <option value="EMT">EMT</option>
                <option value="EMR">EMR</option>
                <option value="Supervisor">Supervisor</option>
              </select>
            </div>
          </div>

          <label>Event Map Link (optional)</label>
          <input id="smap" style="width:100%;" />

          <label>Directions Link (optional)</label>
          <input id="sdir" style="width:100%;" />

          <label>Shift Notes / Instructions</label>
          <textarea id="snotes"></textarea>

          <div class="row" style="margin-top:12px;">
            <button id="postBtn">Post</button>
          </div>
          <div id="perr" class="error"></div>
        </div>` : ``}

        <div id="list" style="margin-top:14px; display:grid; gap:12px;"></div>
      `;

      if (IS_ADMIN) {
        $("postBtn").onclick = async () => {
          const perr = $("perr");
          perr.textContent = "";

          const title = $("stitle").value.trim();
          const startVal = $("sstart").value;
          const endVal = $("send").value;
          const where = $("swhere").value.trim();
          const crew = Math.max(1, parseInt($("screw").value || "1", 10));
          const notes = ($("snotes").value || "").trim();
          const mapUrl = ($("smap").value || "").trim();
          const dirUrl = ($("sdir").value || "").trim();
          const requiredRole = ($("srole").value || "").trim();

          if (!title || !startVal || !endVal) {
            perr.textContent = "Enter a title, start, and end time.";
            return;
          }

          const { error } = await supabase.from("shifts").insert({
            title,
            start_time: startVal,
            end_time: endVal,
            shift_where: where,
            crew_size: crew,
            notes,
            google_map_url: mapUrl || null,
            directions_url: dirUrl || null,
            required_role: requiredRole || null,
            created_by: CURRENT_USER.id
          });

          if (error) return (perr.textContent = error.message);
          alert("Posted ‚úÖ");
          await loadShifts();
        };
      }

      await loadShifts();
    }

    async function loadShifts() {
      const list = $("list");

      const { data, error } = await supabase
        .from("shifts")
        .select("*")
        .order("start_time", { ascending: true });

      if (error) {
        list.innerHTML = `<div class="error">${esc(error.message)}</div>`;
        return;
      }

      const shifts = data || [];
      const shiftIds = shifts.map(s => s.id);
      const approvedCounts = await getApprovedCountsForShiftIds(shiftIds);
      const myStatus = await getMyClaimStatusMapForShiftIds(shiftIds);

      list.innerHTML = shifts.map(s => {
        const cs = Math.max(1, Number(s.crew_size || 1));
        const ac = Number(approvedCounts[s.id] || 0);
        const full = ac >= cs;

        const mine = myStatus[s.id];
        const gate = canUserClaimShift(s);

        let claimBtnHtml = "";
        if (full) claimBtnHtml = `<span class="pill">Filled</span>`;
        else if (mine === "pending") claimBtnHtml = `<span class="pill blue">Pending approval</span>`;
        else if (mine === "approved") claimBtnHtml = `<span class="pill ok">You‚Äôre approved</span>`;
        else if (mine === "removal_requested") claimBtnHtml = `<span class="pill">Removal requested</span>`;
        else if (!gate.ok) claimBtnHtml = `<button disabled>Claim</button><div class="small" style="margin-top:6px;">${esc(gate.reason)}</div>`;
        else claimBtnHtml = `<button onclick="claimShift('${s.id}')">Claim</button>`;

        return `
          <div class="card">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div style="min-width:240px;">
                <div style="font-weight:1000; font-size:16px;">${esc(s.title)}</div>
                <div class="small" style="margin-top:6px;">üïí ${fmtDT(s.start_time)}${s.end_time ? ` ‚Äì ${fmtDT(s.end_time)}` : ""}</div>
                ${s.shift_where ? `<div style="margin-top:8px;"><span class="pill">${esc(s.shift_where)}</span></div>` : ``}
                <div style="margin-top:8px;">
                  <span class="pill" style="margin-right:8px;">${slotsText(ac, cs)}</span>
                  ${full ? `<span class="pill">Full</span>` : `<span class="pill ok">Open</span>`}
                </div>
                ${reqPills(s)}
              </div>
              <div style="text-align:right;">${claimBtnHtml}</div>
            </div>

            ${renderLinkRow(s.google_map_url, s.directions_url)}
            ${renderNotesBox(s.notes)}
          </div>
        `;
      }).join("") || `<div class="pill" style="margin-top:12px;">No shifts posted yet</div>`;
    }

    window.claimShift = async (shiftId) => {
      const { data: shift, error: sErr } = await supabase
        .from("shifts")
        .select("id,crew_size,required_role")
        .eq("id", shiftId)
        .single();
      if (sErr) return alert(sErr.message);

      const gate = canUserClaimShift(shift);
      if (!gate.ok) return alert("Cannot claim: " + gate.reason);

      const { data: mine } = await supabase
        .from("shift_claims")
        .select("id,status")
        .eq("shift_id", shiftId)
        .eq("user_id", CURRENT_USER.id)
        .in("status", ["pending","approved","removal_requested"])
        .limit(1);

      if (mine && mine.length) return alert("You already have a request for this shift.");

      const { data: approvedRows } = await supabase
        .from("shift_claims")
        .select("id")
        .eq("shift_id", shiftId)
        .eq("status", "approved");

      const cs = Math.max(1, Number(shift.crew_size || 1));
      const ac = (approvedRows || []).length;
      if (ac >= cs) return alert("This shift is already filled.");

      const { error } = await supabase.from("shift_claims").insert({
        shift_id: shiftId,
        user_id: CURRENT_USER.id,
        user_email: CURRENT_USER.email,
        status: "pending"
      });
      if (error) return alert(error.message);

      alert("Claim sent for approval.");
      await loadShifts();
    };

    // nav (schedule only for now)
    if (schedBtn) schedBtn.onclick = showSchedule;

    // auto login
    const user = await getUser();
    if (user) await showPortal(user);

  } catch (err) {
    document.body.innerHTML = `
      <div style="padding:20px;font-family:monospace;color:#b00020;">
        <h2>Portal Crash</h2>
        <pre>${String(err && (err.stack || err.message || err))}</pre>
      </div>
    `;
    console.error(err);
  }
})();
</script>