<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>First Line EMS Employee Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f5f6f8; margin:0; }
    .container { max-width: 900px; margin: 40px auto; padding: 20px; }
    .card { background:#fff; border-radius:14px; padding:24px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
    h1 { margin:0 0 12px 0; font-size:24px; }
    input { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:1px solid #ddd; font-size:16px; }
    button { padding:12px 16px; border-radius:10px; border:none; background:#111; color:#fff; font-size:16px; font-weight:700; cursor:pointer; margin-top:10px; }
    button.secondary { background:#eaeaea; color:#111; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .hidden { display:none; }
    .error { color:#b00020; margin-top:10px; font-weight:600; }
    .pill { background:#eee; border-radius:999px; padding:6px 12px; font-size:13px; font-weight:700; }
    .debug { margin-top:10px; font-weight:800; color:#111; }
  </style>
</head>
<body>

<div class="container">

  <!-- LOGIN -->
  <div id="login" class="card">
    <h1>First Line EMS – Employee Login</h1>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn">Login</button>

    <div id="debug" class="debug"></div>
    <div id="loginError" class="error"></div>
  </div>

  <!-- PORTAL -->
  <div id="portal" class="card hidden">
    <div class="row" style="justify-content:space-between;">
      <span class="pill" id="userEmail"></span>
      <button class="secondary" id="logoutBtn">Logout</button>
    </div>

    <h1 style="margin-top:16px;">Employee Portal</h1>

    <div class="row">
      <button id="schedBtn">Scheduling</button>
      <button id="annBtn">Announcements</button>
    </div>

    <div id="content"></div>
  </div>

</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // ====== SUPABASE ======
  const SUPABASE_URL = "https://lnevuelwsiewxdrmgckh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuZXZ1ZWx3c2lld3hkcm1nY2toIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzMyNjgsImV4cCI6MjA4NjMwOTI2OH0.voDpAvnscFh9-e70-xV4UBxtcO-TwYbU6V0JRPUFFIs";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== UI / DEBUG ======
  const debugEl = document.getElementById("debug");
  const setDebug = (msg) => { debugEl.textContent = msg || ""; };

  window.addEventListener("error", (e) => setDebug("JS error: " + (e?.message || e)));
  window.addEventListener("unhandledrejection", (e) => setDebug("Promise error: " + (e?.reason?.message || e?.reason || e)));

  setDebug("JS loaded ✅");

  const loginEl = document.getElementById("login");
  const portalEl = document.getElementById("portal");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const schedBtn = document.getElementById("schedBtn");
  const annBtn = document.getElementById("annBtn");

  const loginError = document.getElementById("loginError");
  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  const userEmailEl = document.getElementById("userEmail");
  const contentEl = document.getElementById("content");

  const escapeHtml = (str) =>
    String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));

  function showAnnouncements() {
    contentEl.innerHTML = `
      <h3>Announcements</h3>
      <p>Announcements will appear here.</p>
    `;
  }

  async function showSchedule() {
    contentEl.innerHTML = `
      <h3>Scheduling</h3>
      <p>Shared shift board (stored in Supabase).</p>

      <div class="card" style="box-shadow:none; border:1px solid #ddd; margin-top:12px;">
        <h4 style="margin:0 0 10px 0;">Post a Shift</h4>
        <input id="shiftTitle" placeholder="Shift title (e.g., Camp trip EMT - Saturday)" />
        <input id="shiftWhen" placeholder="When (e.g., Sat 9am–5pm)" />
        <input id="shiftWhere" placeholder="Where (e.g., Six Flags NJ)" />
        <button id="postShiftBtn">Post Shift</button>
        <div id="postErr" class="error"></div>
      </div>

      <div style="margin-top:14px;">
        <h4 style="margin:0 0 10px 0;">Available Shifts</h4>
        <div id="shiftList" style="display:grid; gap:10px;"></div>
      </div>
    `;

    const shiftList = document.getElementById("shiftList");
    const postErr = document.getElementById("postErr");

    async function loadShifts() {
      shiftList.innerHTML = `<div class="pill">Loading…</div>`;

      const { data, error } = await supabase
        .from("shifts")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        shiftList.innerHTML = `<div class="error">Error loading shifts: ${escapeHtml(error.message)}</div>`;
        return;
      }

      if (!data || data.length === 0) {
        shiftList.innerHTML = `<div class="pill">No shifts posted yet</div>`;
        return;
      }

      shiftList.innerHTML = "";
      data.forEach((s) => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.boxShadow = "none";
        div.style.border = "1px solid #ddd";

        div.innerHTML = `
          <div style="font-weight:900;">${escapeHtml(s.title)}</div>
          <div style="color:#444; margin-top:4px;">${escapeHtml(s.shift_when)}</div>
          <div style="color:#666; margin-top:2px;">${escapeHtml(s.shift_where || "")}</div>
          <div class="row" style="margin-top:10px;">
            <button class="secondary" data-claim="${s.id}">Claim</button>
          </div>
        `;
        shiftList.appendChild(div);
      });

      // Claim buttons -> insert into shift_claims
      shiftList.querySelectorAll("[data-claim]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const shiftId = btn.getAttribute("data-claim");

          const { data: sess } = await supabase.auth.getSession();
          const userId = sess?.session?.user?.id;

          if (!userId) {
            alert("You must be logged in.");
            return;
          }

          btn.disabled = true;
          const oldText = btn.textContent;
          btn.textContent = "Claiming...";

          const { error } = await supabase.from("shift_claims").insert({
            shift_id: shiftId,
            user_id: userId,
            status: "pending"
          });

          if (error) {
            btn.disabled = false;
            btn.textContent = oldText;
            alert("Claim failed: " + error.message);
            return;
          }

          btn.textContent = "Claim sent ✅";
        });
      });
    }

    document.getElementById("postShiftBtn").addEventListener("click", async () => {
      postErr.textContent = "";

      const title = document.getElementById("shiftTitle").value.trim();
      const shift_when = document.getElementById("shiftWhen").value.trim();
      const shift_where = document.getElementById("shiftWhere").value.trim();

      if (!title || !shift_when) {
        postErr.textContent = "Enter at least a title + when.";
        return;
      }

      const { data: sess } = await supabase.auth.getSession();
      const userId = sess?.session?.user?.id || null;

      const { error } = await supabase.from("shifts").insert({
        title,
        shift_when,
        shift_where,
        created_by: userId
      });

      if (error) {
        postErr.textContent = error.message;
        return;
      }

      document.getElementById("shiftTitle").value = "";
      document.getElementById("shiftWhen").value = "";
      document.getElementById("shiftWhere").value = "";

      await loadShifts();
    });

    await loadShifts();
  }

  function showPortal(user) {
    loginEl.classList.add("hidden");
    portalEl.classList.remove("hidden");
    userEmailEl.textContent = user.email;
    showSchedule();
  }

  // LOGIN
  loginBtn.addEventListener("click", async () => {
    setDebug("Login clicked ✅");
    loginError.textContent = "";

    const email = emailEl.value.trim();
    const password = passwordEl.value.trim();

    if (!email || !password) {
      loginError.textContent = "Enter email and password.";
      return;
    }

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      loginError.textContent = error.message;
      return;
    }

    showPortal(data.user);
  });

  // LOGOUT
  logoutBtn.addEventListener("click", async () => {
    await supabase.auth.signOut();
    location.reload();
  });

  // NAV BUTTONS
  schedBtn.addEventListener("click", async () => {
    setDebug("Scheduling clicked ✅");
    try { await showSchedule(); } catch (e) { setDebug("Scheduling error: " + (e?.message || e)); }
  });

  annBtn.addEventListener("click", () => {
    setDebug("Announcements clicked ✅");
    try { showAnnouncements(); } catch (e) { setDebug("Announcements error: " + (e?.message || e)); }
  });

  // AUTO LOGIN
  const { data } = await supabase.auth.getSession();
  if (data?.session?.user) showPortal(data.session.user);
</script>

</body>
</html>
