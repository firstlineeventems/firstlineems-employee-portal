<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>First Line EMS Employee Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 10px 25px rgba(0,0,0,.07);
      --brand:#0f172a;
      --brand2:#111827;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --danger:#b00020;
      --ok:#0f766e;
      --warn:#b45309;
    }
    *{box-sizing:border-box}
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); margin:0; color:var(--text); }
    .container { max-width:980px; margin:40px auto; padding:20px; }
    .card { background:var(--card); border-radius:16px; padding:22px; box-shadow:var(--shadow); border:1px solid var(--line); }
    .hidden { display:none; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button {
      padding:12px 16px; border-radius:12px; border:1px solid transparent;
      background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff; font-weight:900; cursor:pointer;
      box-shadow:0 10px 18px rgba(17,24,39,.14);
    }
    button.secondary { background:#fff; color:var(--text); border-color:var(--line); box-shadow:none; font-weight:900; }
    button.danger { background:linear-gradient(180deg,#b00020,#8a0018); }
    button:disabled { opacity:.55; cursor:not-allowed; box-shadow:none; }

    input, textarea, select {
      padding:11px 12px; border-radius:12px; border:1px solid var(--line);
      background:#fff; color:var(--text); outline:none;
    }
    input:focus, textarea:focus, select:focus{ border-color:rgba(37,99,235,.45); box-shadow:0 0 0 4px rgba(37,99,235,.12); }
    textarea { width:100%; min-height:92px; resize:vertical; }

    .error { color:var(--danger); font-weight:800; margin-top:8px; }
    .pill {
      background:#f3f4f6; padding:6px 12px; border-radius:999px; font-size:13px; font-weight:1000;
      border:1px solid var(--line); display:inline-flex; align-items:center; gap:8px;
    }
    .pill.ok { background:rgba(15,118,110,.08); border-color:rgba(15,118,110,.25); color:var(--ok); }
    .pill.blue { background:rgba(37,99,235,.08); border-color:rgba(37,99,235,.25); color:var(--accent2); }
    .pill.warn { background:rgba(180,83,9,.10); border-color:rgba(180,83,9,.25); color:var(--warn); }

    .debug { font-weight:900; margin-top:10px; color:var(--muted); }
    hr { border:none; border-top:1px solid var(--line); margin:16px 0; }
    .small { color:var(--muted); font-size:13px; }
    .noteBox { margin-top:10px; padding:12px; border:1px solid var(--line); border-radius:14px; background:#fafafa; }
    .noteTitle { font-weight:1000; margin-bottom:6px; }
    label { font-weight:1000; display:block; margin:10px 0 6px; color:#111827; }
    h2,h3,h4{margin:0 0 10px 0}

    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      margin-bottom:14px;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8);
      box-shadow:0 10px 20px rgba(37,99,235,.20);
    }
    .brandTitle{display:flex; flex-direction:column; gap:2px}
    .brandTitle .name{font-weight:1000; letter-spacing:.2px}
    .brandTitle .tag{font-size:13px; color:var(--muted); font-weight:800}

    .nav{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .nav button{
      background:#fff; border:1px solid var(--line); color:var(--text); box-shadow:none; font-weight:1000;
    }
    .nav button.active{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }

    .sectionCard{margin-top:14px; border-radius:16px;}
    .grid5{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
      align-items:end;
    }
    .linkRow{
      display:flex; gap:14px; flex-wrap:wrap; margin-top:10px;
    }
    .linkRow a{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid var(--line); border-radius:12px;
      background:#fff; box-shadow:none; font-weight:1000; color:var(--accent); text-decoration:none;
    }
    .linkRow a:hover{text-decoration:underline}
    @media (max-width: 900px){
      .grid5{grid-template-columns: 1fr 1fr}
      .container{margin:20px auto}
    }
  </style>
</head>
<body>

<div class="container">

  <!-- LOGIN -->
  <div id="login" class="card">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandTitle">
          <div class="name">First Line EMS</div>
          <div class="tag">Employee Portal</div>
        </div>
      </div>
      <span class="pill blue">Secure Login</span>
    </div>

    <h2>Sign in</h2>
    <div class="small">Use your employee account email + password.</div>

    <div style="height:10px"></div>

    <label for="email">Email</label>
    <input id="email" placeholder="Email" autocomplete="username" style="width:100%;" />

    <label for="password">Password</label>
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="width:100%;" />

    <div style="height:12px"></div>
    <div class="row">
      <button id="loginBtn">Login</button>
      <span id="debug" class="debug"></span>
    </div>

    <div id="loginError" class="error"></div>
  </div>

  <!-- PORTAL -->
  <div id="portal" class="card hidden">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandTitle">
          <div class="name">First Line EMS</div>
          <div class="tag">Employee Portal</div>
        </div>
      </div>

      <div class="row">
        <span id="userEmail" class="pill"></span>
        <button id="logoutBtn" class="secondary">Logout</button>
      </div>
    </div>

    <div class="nav">
      <button id="schedBtn" class="active">Scheduling</button>
      <button id="apprBtn">Approvals</button>
      <button id="usersBtn">Users</button>
    </div>

    <div id="content"></div>
  </div>

</div>

<script type="module">
(async () => {
  const crash = (title, details) => {
    document.body.innerHTML = `
      <div style="padding:18px;font-family:ui-monospace,Menlo,Consolas,monospace;color:#b00020;">
        <h2 style="margin:0 0 10px 0;">${title}</h2>
        <pre style="white-space:pre-wrap;margin:0;">${details}</pre>
      </div>
    `;
  };

  try {
    if (document.readyState === "loading") {
      await new Promise(r => document.addEventListener("DOMContentLoaded", r, { once:true }));
    }

    const $ = (id) => document.getElementById(id);
    const must = ["login","portal","content","email","password","loginBtn","logoutBtn"];

    const missing = must.filter(id => !$(id));
    if (missing.length) {
      crash("Portal Crash: HTML ID mismatch", `Missing required IDs:\n- ${missing.join("\n- ")}`);
      return;
    }

    let createClient;
    try {
      ({ createClient } = await import("https://esm.sh/@supabase/supabase-js@2"));
    } catch (e) {
      crash("Portal Crash: Supabase import failed", String(e && (e.stack || e.message || e)));
      return;
    }

    const supabase = createClient(
      "https://lnevuelwsiewxdrmgckh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuZXZ1ZWx3c2lld3hkcm1nY2toIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzMyNjgsImV4cCI6MjA4NjMwOTI2OH0.voDpAvnscFh9-e70-xV4UBxtcO-TwYbU6V0JRPUFFIs"
    );

    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));

    const debug = (msg) => {
      const el = $("debug");
      if (el) el.textContent = msg;
      console.log("[PORTAL]", msg);
    };

    debug("JS loaded ‚úÖ");

    const login = $("login");
    const portal = $("portal");
    const content = $("content");
    const email = $("email");
    const password = $("password");
    const loginBtn = $("loginBtn");
    const logoutBtn = $("logoutBtn");
    const loginError = $("loginError");
    const userEmail = $("userEmail");

    const schedBtn = $("schedBtn");
    const apprBtn = $("apprBtn");
    const usersBtn = $("usersBtn");

    let CURRENT_USER = null;
    let IS_ADMIN = false;
    let MY_CREDS = { role: null };

    function setActiveNav(btn){
      [schedBtn, apprBtn, usersBtn].filter(Boolean).forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    }

    async function getUser() {
      const { data } = await supabase.auth.getSession();
      return data?.session?.user || null;
    }

    async function checkAdmin(userId) {
  const { data, error } = await supabase
    .from("user_roles")
    .select("is_admin")
    .or(`user_id.eq.${userId},auth_user_id.eq.${userId},roles_user_id.eq.${userId}`)
    .maybeSingle();

  if (error) {
    console.log("checkAdmin error:", error);
    return false;
  }
  return !!data?.is_admin;
}

async function loadMyCreds(userId) {
  const { data, error } = await supabase
    .from("user_roles")
    .select("role")
    .or(`user_id.eq.${userId},auth_user_id.eq.${userId},roles_user_id.eq.${userId}`)
    .maybeSingle();

  if (error) {
    console.log("loadMyCreds error:", error);
    return { role: null };
  }
  return { role: data?.role ?? null };
}

    function fmtDT(dt) {
      if (!dt) return "";
      try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
    }

    function renderNotesBox(notes) {
      const n = (notes || "").trim();
      if (!n) return "";
      return `
        <div class="noteBox">
          <div class="noteTitle">Notes</div>
          <div>${esc(n).replace(/\n/g,"<br>")}</div>
        </div>
      `;
    }

    function renderLinkRow(mapUrl, directionsUrl) {
      const a = [];
      const map = (mapUrl || "").trim();
      const dir = (directionsUrl || "").trim();
      if (map) a.push(`<a href="${esc(map)}" target="_blank" rel="noopener">üó∫Ô∏è Event Map</a>`);
      if (dir) a.push(`<a href="${esc(dir)}" target="_blank" rel="noopener">üß≠ Directions</a>`);
      if (!a.length) return "";
      return `<div class="linkRow">${a.join("")}</div>`;
    }

    function canUserClaimShift(s) {
      if (s.required_role) {
        const need = String(s.required_role).trim().toLowerCase();
        const have = String(MY_CREDS.role || "").trim().toLowerCase();
        if (!have || have !== need) return { ok:false, reason:`Requires ${s.required_role}` };
      }
      return { ok:true, reason:"" };
    }

    async function getApprovedCountsForShiftIds(shiftIds) {
      const map = {};
      shiftIds.forEach(id => map[id] = 0);
      if (!shiftIds.length) return map;

      const { data } = await supabase
        .from("shift_claims")
        .select("shift_id")
        .in("shift_id", shiftIds)
        .eq("status", "approved");

      (data || []).forEach(r => map[r.shift_id] = (map[r.shift_id] || 0) + 1);
      return map;
    }

    async function getMyClaimStatusMapForShiftIds(shiftIds) {
      const map = {};
      if (!shiftIds.length) return map;

      const { data } = await supabase
        .from("shift_claims")
        .select("shift_id,status")
        .in("shift_id", shiftIds)
        .eq("user_id", CURRENT_USER.id)
        .in("status", ["pending","approved","removal_requested"]);

      (data || []).forEach(r => { map[r.shift_id] = r.status; });
      return map;
    }

    function slotsText(approvedCount, crewSize) {
      const cs = Math.max(1, Number(crewSize || 1));
      const ac = Number(approvedCount || 0);
      return `${ac}/${cs} filled`;
    }

    // ---- Auth buttons ----
    loginBtn.onclick = async () => {
      if (loginError) loginError.textContent = "";
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value,
        password: password.value
      });
      if (error) {
        if (loginError) loginError.textContent = error.message;
        return;
      }
      await showPortal(data.user);
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    async function showPortal(user) {
      CURRENT_USER = user;
      IS_ADMIN = await checkAdmin(user.id);
      MY_CREDS = await loadMyCreds(user.id);

      login.classList.add("hidden");
      portal.classList.remove("hidden");
      if (userEmail) userEmail.textContent = user.email;

      // hide admin tabs unless admin
      if (apprBtn) apprBtn.style.display = IS_ADMIN ? "inline-block" : "none";
      if (usersBtn) usersBtn.style.display = IS_ADMIN ? "inline-block" : "none";

      await showSchedule();
    }

    async function showSchedule() {
      setActiveNav(schedBtn);

      content.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <h3>Scheduling</h3>
            <div class="small">Claim shifts for approval.</div>
            <div class="small" style="margin-top:6px;">Your role: <b>${esc(MY_CREDS.role || "Not set")}</b></div>
          </div>
          <span class="pill blue">${IS_ADMIN ? "Admin" : "Employee"}</span>
        </div>
        <div id="list" style="margin-top:14px; display:grid; gap:12px;"></div>
      `;
      await loadShifts();
    }

    async function loadShifts() {
      const list = $("list");
      if (!list) return;

      const { data, error } = await supabase
        .from("shifts")
        .select("*")
        .order("start_time", { ascending: true });

      if (error) {
        list.innerHTML = `<div class="error">${esc(error.message)}</div>`;
        return;
      }

      const shifts = data || [];
      const shiftIds = shifts.map(s => s.id);

      const approvedCounts = await getApprovedCountsForShiftIds(shiftIds);
      const myStatus = CURRENT_USER ? await getMyClaimStatusMapForShiftIds(shiftIds) : {};

      list.innerHTML = shifts.map(s => {
        const cs = Math.max(1, Number(s.crew_size || 1));
        const ac = Number(approvedCounts[s.id] || 0);
        const full = ac >= cs;

        const mine = myStatus[s.id];
        const gate = canUserClaimShift(s);

        let claimBtnHtml = "";
        if (full) claimBtnHtml = `<span class="pill">Filled</span>`;
        else if (mine === "pending") claimBtnHtml = `<span class="pill blue">Pending</span>`;
        else if (mine === "approved") claimBtnHtml = `<span class="pill ok">Approved</span>`;
        else if (!gate.ok) claimBtnHtml = `<button disabled>Claim</button><div class="small" style="margin-top:6px;">${esc(gate.reason)}</div>`;
        else claimBtnHtml = `<button onclick="claimShift('${s.id}')">Claim</button>`;

        return `
          <div class="card">
            <div style="font-weight:1000;">${esc(s.title)}</div>
            <div class="small" style="margin-top:6px;">üïí ${fmtDT(s.start_time)}${s.end_time ? ` ‚Äì ${fmtDT(s.end_time)}` : ""}</div>
            ${renderLinkRow(s.google_map_url, s.directions_url)}
            ${renderNotesBox(s.notes)}
            <div style="margin-top:10px;">
              <span class="pill">${slotsText(ac, cs)}</span>
              <span style="margin-left:8px;">${claimBtnHtml}</span>
            </div>
          </div>
        `;
      }).join("") || `<div class="pill">No shifts posted yet</div>`;
    }

    window.claimShift = async (shiftId) => {
      if (!CURRENT_USER) return alert("Log in first.");

      const { data: shift, error: sErr } = await supabase
        .from("shifts")
        .select("id,crew_size,required_role")
        .eq("id", shiftId)
        .single();
      if (sErr) return alert(sErr.message);

      const gate = canUserClaimShift(shift);
      if (!gate.ok) return alert("Cannot claim: " + gate.reason);

      const { error } = await supabase.from("shift_claims").insert({
        shift_id: shiftId,
        user_id: CURRENT_USER.id,
        user_email: CURRENT_USER.email,
        status: "pending"
      });
      if (error) return alert(error.message);

      alert("Claim sent ‚úÖ");
      await loadShifts();
    };

    // nav wiring
    schedBtn.onclick = showSchedule;
    apprBtn.onclick = () => alert("Approvals UI not wired in this slim build yet.");
    usersBtn.onclick = () => alert("Users UI not wired in this slim build yet.");

    // auto login
    const user = await getUser();
    if (user) await showPortal(user);

  } catch (err) {
    crash("Portal Crash", String(err && (err.stack || err.message || err)));
  }
})();
</script>

</body>
</html>