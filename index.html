<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>First Line EMS Employee Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body { font-family: system-ui; background:#f5f6f8; margin:0; }
.container { max-width:900px; margin:40px auto; padding:20px; }
.card { background:#fff; border-radius:14px; padding:24px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
.hidden { display:none; }
.row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
button { padding:12px 16px; border-radius:10px; border:none; background:#111; color:#fff; font-weight:700; cursor:pointer; }
button.secondary { background:#eaeaea; color:#111; }
input { padding:10px; border-radius:8px; border:1px solid #ccc; }
.error { color:#b00020; font-weight:600; margin-top:8px; }
.pill { background:#eee; padding:6px 12px; border-radius:999px; font-size:13px; font-weight:700; }
.adminBadge { background:#111; color:#fff; }
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div id="login" class="card">
  <h2>Employee Login</h2>
  <input id="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <div id="loginError" class="error"></div>
</div>

<!-- PORTAL -->
<div id="portal" class="card hidden">
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <span id="userEmail" class="pill"></span>
      <span id="roleBadge" class="pill"></span>
    </div>
    <button id="logoutBtn" class="secondary">Logout</button>
  </div>

  <div class="row" style="margin-top:14px">
    <button id="schedBtn">Scheduling</button>
    <button id="myBtn">My Shifts</button>
    <button id="apprBtn">Approvals</button>
  </div>

  <div id="content"></div>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://lnevuelwsiewxdrmgckh.supabase.co",
  "YOUR_ANON_KEY_HERE"
);

const esc = s => String(s ?? "").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));

let CURRENT_USER = null;
let IS_ADMIN = false;

async function getUser() {
  const { data } = await supabase.auth.getSession();
  return data?.session?.user;
}

async function checkAdmin(userId) {
  const { data, error } = await supabase
    .from("user_roles")
    .select("is_admin")
    .eq("user_id", userId)
    .maybeSingle();

  if (error) {
    console.error("Admin check error:", error);
    return false;
  }

  return !!data?.is_admin;
}

loginBtn.onclick = async () => {
  loginError.textContent = "";
  const { data, error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) return loginError.textContent = error.message;
  await showPortal(data.user);
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

async function showPortal(user) {
  CURRENT_USER = user;
  IS_ADMIN = await checkAdmin(user.id);

  login.classList.add("hidden");
  portal.classList.remove("hidden");

  userEmail.textContent = user.email;

  const roleBadge = document.getElementById("roleBadge");
  roleBadge.textContent = IS_ADMIN ? "Admin" : "Employee";
  roleBadge.className = IS_ADMIN ? "pill adminBadge" : "pill";

  apprBtn.style.display = IS_ADMIN ? "inline-block" : "none";

  showSchedule();
}

async function showSchedule() {
  content.innerHTML = `
    <h3>Scheduling</h3>
    ${IS_ADMIN ? `
      <div class="card">
        <h4>Post Shift</h4>
        <input id="stitle" placeholder="Title" />
        <input id="sstart" type="datetime-local" />
        <input id="send" type="datetime-local" />
        <button id="postBtn">Post</button>
      </div>
    ` : ""}
    <div id="list"></div>
  `;

  if (IS_ADMIN) {
    postBtn.onclick = async () => {
      const { error } = await supabase.from("shifts").insert({
        title: stitle.value,
        start_time: sstart.value,
        end_time: send.value,
        created_by: CURRENT_USER.id
      });
      if (error) return alert(error.message);
      loadShifts();
    };
  }

  loadShifts();
}

async function loadShifts() {
  const { data } = await supabase
    .from("shifts")
    .select("*")
    .order("start_time", { ascending: true });

  list.innerHTML = (data || []).map(s => `
    <div class="card">
      <b>${esc(s.title)}</b><br>
      ${s.start_time ? new Date(s.start_time).toLocaleString() : ""}
    </div>
  `).join("") || `<div class="pill">No shifts posted yet</div>`;
}

apprBtn.onclick = async () => {
  content.innerHTML = `<h3>Approvals (Admin Only)</h3>`;
};

schedBtn.onclick = showSchedule;

const user = await getUser();
if (user) await showPortal(user);

</script>
</body>
</html>
