<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>First Line EMS Employee Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body { font-family: system-ui; background:#f5f6f8; margin:0; }
.container { max-width:900px; margin:40px auto; padding:20px; }
.card { background:#fff; border-radius:14px; padding:24px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
.hidden { display:none; }
.row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
button { padding:12px 16px; border-radius:10px; border:none; background:#111; color:#fff; font-weight:700; cursor:pointer; }
button.secondary { background:#eaeaea; color:#111; }
button.danger { background:#b00020; }
button:disabled { opacity:.55; cursor:not-allowed; }
input, textarea { padding:10px; border-radius:8px; border:1px solid #ccc; }
textarea { width:100%; min-height:90px; resize:vertical; }
.error { color:#b00020; font-weight:600; margin-top:8px; }
.pill { background:#eee; padding:6px 12px; border-radius:999px; font-size:13px; font-weight:700; display:inline-block; }
.debug { font-weight:800; margin-top:10px; }
hr { border:none; border-top:1px solid #eee; margin:16px 0; }
.small { color:#666; font-size:13px; }
.noteBox { margin-top:10px; padding:12px; border:1px solid #ddd; border-radius:12px; background:#fafafa; }
.noteTitle { font-weight:900; margin-bottom:6px; }
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div id="login" class="card">
  <h2>Employee Login</h2>
  <input id="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <div id="debug" class="debug"></div>
  <div id="loginError" class="error"></div>
</div>

<!-- PORTAL -->
<div id="portal" class="card hidden">
  <div class="row" style="justify-content:space-between">
    <span id="userEmail" class="pill"></span>
    <button id="logoutBtn" class="secondary">Logout</button>
  </div>

  <div class="row" style="margin-top:14px">
    <button id="schedBtn">Scheduling</button>
    <button id="calBtn">Calendar</button>
    <button id="myBtn">My Requests / Shifts</button>
    <button id="annBtn">Announcements</button>
    <button id="apprBtn">Approvals</button>
  </div>

  <div id="content"></div>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://lnevuelwsiewxdrmgckh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuZXZ1ZWx3c2lld3hkcm1nY2toIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzMyNjgsImV4cCI6MjA4NjMwOTI2OH0.voDpAvnscFh9-e70-xV4UBxtcO-TwYbU6V0JRPUFFIs"
);

const esc = s => String(s ?? "").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
const debug = msg => document.getElementById("debug").textContent = msg;
debug("JS loaded ✅");

let CURRENT_USER = null;
let IS_ADMIN = false;

// ===== helpers =====
async function getUser() {
  const { data } = await supabase.auth.getSession();
  return data?.session?.user;
}

async function checkAdmin(userId) {
  const { data } = await supabase
    .from("user_roles")
    .select("is_admin")
    .eq("user_id", userId)
    .single();
  return !!data?.is_admin;
}

function fmtDT(dt) {
  if (!dt) return "";
  try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
}

// Monday-start week helpers
function startOfWeek(d) {
  const date = new Date(d);
  const day = (date.getDay() + 6) % 7; // Mon=0 ... Sun=6
  date.setHours(0,0,0,0);
  date.setDate(date.getDate() - day);
  return date;
}
function addDays(d, n) {
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return x;
}
function fmtDay(d) {
  return d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
}
function fmtTime(d) {
  return d.toLocaleTimeString(undefined, { hour: "numeric", minute: "2-digit" });
}

// ===== auth UI =====
loginBtn.onclick = async () => {
  loginError.textContent = "";
  const { data, error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) return loginError.textContent = error.message;
  await showPortal(data.user);
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

async function showPortal(user) {
  CURRENT_USER = user;
  IS_ADMIN = await checkAdmin(user.id);

  login.classList.add("hidden");
  portal.classList.remove("hidden");
  userEmail.textContent = user.email;

  apprBtn.style.display = IS_ADMIN ? "inline-block" : "none";

  await showSchedule();
}

// ===== Core data helpers for slots / claims =====
async function getApprovedCountsForShiftIds(shiftIds) {
  const map = {};
  shiftIds.forEach(id => map[id] = 0);
  if (!shiftIds.length) return map;

  const { data, error } = await supabase
    .from("shift_claims")
    .select("shift_id,status")
    .in("shift_id", shiftIds)
    .eq("status", "approved");

  if (error) return map;

  (data || []).forEach(r => {
    map[r.shift_id] = (map[r.shift_id] || 0) + 1;
  });
  return map;
}

async function getMyClaimStatusMapForShiftIds(shiftIds) {
  const map = {}; // shift_id -> status
  if (!shiftIds.length) return map;

  const { data, error } = await supabase
    .from("shift_claims")
    .select("shift_id,status")
    .in("shift_id", shiftIds)
    .eq("user_id", CURRENT_USER.id)
    .in("status", ["pending","approved","removal_requested"]);

  if (error) return map;

  (data || []).forEach(r => { map[r.shift_id] = r.status; });
  return map;
}

function slotsText(approvedCount, crewSize) {
  const cs = Math.max(1, Number(crewSize || 1));
  const ac = Number(approvedCount || 0);
  return `${ac}/${cs} filled`;
}

// ===== Scheduling (list) =====
async function showSchedule() {
  content.innerHTML = `
    <h3>Scheduling</h3>

    ${IS_ADMIN ? `
    <div class="card">
      <h4>Post Shift</h4>
      <div class="row" style="align-items:flex-end;">
        <div style="flex:1; min-width:180px;">
          <div style="font-weight:700; margin-bottom:6px;">Title</div>
          <input id="stitle" placeholder="Title" style="width:100%;" />
        </div>
        <div style="flex:1; min-width:180px;">
          <div style="font-weight:700; margin-bottom:6px;">Start</div>
          <input id="sstart" type="datetime-local" style="width:100%;" />
        </div>
        <div style="flex:1; min-width:180px;">
          <div style="font-weight:700; margin-bottom:6px;">End</div>
          <input id="send" type="datetime-local" style="width:100%;" />
        </div>
        <div style="flex:1; min-width:180px;">
          <div style="font-weight:700; margin-bottom:6px;">Where</div>
          <input id="swhere" placeholder="Where" style="width:100%;" />
        </div>
        <div style="width:130px;">
          <div style="font-weight:700; margin-bottom:6px;">Crew Size</div>
          <input id="screw" type="number" min="1" value="1" style="width:100%;" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <div style="font-weight:700; margin-bottom:6px;">Shift Notes / Instructions</div>
        <textarea id="snotes" placeholder="Example: Meet at main gate 30 mins early. Uniform: Class B polo. Call supervisor if late."></textarea>
      </div>

      <button id="postBtn" style="margin-top:12px;">Post</button>
      <div id="perr" class="error"></div>
      <div class="small" style="margin-top:6px;">Crew size = how many employees can be approved for this shift.</div>
    </div>` : ``}

    <div id="list"></div>
  `;

  if (IS_ADMIN) {
    postBtn.onclick = async () => {
      perr.textContent = "";

      const title = stitle.value.trim();
      const where = swhere.value.trim();
      const startVal = sstart.value;
      const endVal = send.value;
      const crew = Math.max(1, parseInt(screw.value || "1", 10));
      const notes = (snotes.value || "").trim();

      if (!title || !startVal || !endVal) {
        perr.textContent = "Enter a title, start, and end time.";
        return;
      }

      const { error } = await supabase.from("shifts").insert({
        title,
        start_time: startVal,
        end_time: endVal,
        shift_where: where,
        crew_size: crew,
        notes,
        created_by: CURRENT_USER.id
      });

      if (error) {
        perr.textContent = error.message;
        return;
      }

      stitle.value = "";
      sstart.value = "";
      send.value = "";
      swhere.value = "";
      screw.value = "1";
      snotes.value = "";

      await loadShifts();
    };
  }

  await loadShifts();
}

async function loadShifts() {
  const { data, error } = await supabase
    .from("shifts")
    .select("*")
    .order("start_time", { ascending: true });

  if (error) {
    content.innerHTML += `<div class="error">${esc(error.message)}</div>`;
    return;
  }

  const shifts = data || [];
  const shiftIds = shifts.map(s => s.id);

  const approvedCounts = await getApprovedCountsForShiftIds(shiftIds);
  const myStatus = await getMyClaimStatusMapForShiftIds(shiftIds);

  list.innerHTML = shifts.map(s => {
    const cs = Math.max(1, Number(s.crew_size || 1));
    const ac = Number(approvedCounts[s.id] || 0);
    const full = ac >= cs;

    const mine = myStatus[s.id];
    let claimBtnHtml = "";

    if (full) claimBtnHtml = `<span class="pill">Filled</span>`;
    else if (mine === "pending") claimBtnHtml = `<span class="pill">Pending approval</span>`;
    else if (mine === "approved") claimBtnHtml = `<span class="pill">You’re approved</span>`;
    else if (mine === "removal_requested") claimBtnHtml = `<span class="pill">Removal requested</span>`;
    else claimBtnHtml = `<button onclick="claimShift('${s.id}')">Claim</button>`;

    const notesHtml = (s.notes && String(s.notes).trim().length)
      ? `<div class="noteBox"><div class="noteTitle">Notes</div><div>${esc(s.notes).replace(/\n/g,"<br>")}</div></div>`
      : ``;

    const adminBtns = IS_ADMIN ? `
      <div class="row" style="margin-top:10px;">
        <button class="secondary" onclick="manageShift('${s.id}')">Manage</button>
        <button class="danger" onclick="deleteShift('${s.id}')">Delete</button>
      </div>
      <div class="small">Manage = remove approved members. Delete = remove shift entirely.</div>
    ` : ``;

    return `
      <div class="card">
        <b>${esc(s.title)}</b><br>
        ${fmtDT(s.start_time)}${s.end_time ? ` – ${fmtDT(s.end_time)}` : ""}<br>
        ${s.shift_where ? `<span class="pill">${esc(s.shift_where)}</span>` : ``}
        <span class="pill" style="margin-left:8px;">${slotsText(ac, cs)}</span>

        ${notesHtml}

        <div style="margin-top:12px;">
          ${claimBtnHtml}
        </div>
        ${adminBtns}
      </div>
    `;
  }).join("") || `<div class="pill" style="margin-top:12px;">No shifts posted yet</div>`;
}

// ===== Claim / Cancel / Removal Request =====
window.claimShift = async (shiftId) => {
  const { data: mine, error: mineErr } = await supabase
    .from("shift_claims")
    .select("id,status")
    .eq("shift_id", shiftId)
    .eq("user_id", CURRENT_USER.id)
    .in("status", ["pending","approved","removal_requested"])
    .limit(1);

  if (mineErr) return alert(mineErr.message);
  if (mine && mine.length) return alert("You already have a request for this shift.");

  const { data: shift, error: sErr } = await supabase
    .from("shifts")
    .select("id,crew_size")
    .eq("id", shiftId)
    .single();
  if (sErr) return alert(sErr.message);

  const { data: approvedRows, error: aErr } = await supabase
    .from("shift_claims")
    .select("id")
    .eq("shift_id", shiftId)
    .eq("status", "approved");
  if (aErr) return alert(aErr.message);

  const cs = Math.max(1, Number(shift.crew_size || 1));
  const ac = (approvedRows || []).length;
  if (ac >= cs) return alert("This shift is already filled.");

  const { error } = await supabase.from("shift_claims").insert({
    shift_id: shiftId,
    user_id: CURRENT_USER.id,
    user_email: CURRENT_USER.email,
    status: "pending"
  });

  if (error) return alert(error.message);

  alert("Claim sent for approval.");
  await loadShifts();
};

window.cancelMyPending = async (claimId) => {
  const { error } = await supabase
    .from("shift_claims")
    .update({ status: "canceled" })
    .eq("id", claimId)
    .eq("user_id", CURRENT_USER.id);

  if (error) return alert(error.message);
  alert("Request canceled.");
  await showMyRequests();
};

window.requestRemoval = async (claimId) => {
  const { error } = await supabase
    .from("shift_claims")
    .update({ status: "removal_requested" })
    .eq("id", claimId)
    .eq("user_id", CURRENT_USER.id);

  if (error) return alert(error.message);
  alert("Removal request sent to admin.");
  await showMyRequests();
};

// ===== My Requests / My Shifts (combined) =====
async function showMyRequests() {
  const { data, error } = await supabase
    .from("shift_claims")
    .select("id,status,created_at,shift_id,shifts(title,start_time,end_time,shift_where,crew_size,notes)")
    .eq("user_id", CURRENT_USER.id)
    .in("status", ["pending","approved","removal_requested"])
    .order("created_at", { ascending: false });

  if (error) {
    content.innerHTML = `<div class="error">${esc(error.message)}</div>`;
    return;
  }

  const rows = data || [];
  const pending = rows.filter(r => r.status === "pending");
  const approved = rows.filter(r => r.status === "approved");
  const removal = rows.filter(r => r.status === "removal_requested");

  const renderNotes = (n) => (n && String(n).trim().length)
    ? `<div class="noteBox"><div class="noteTitle">Notes</div><div>${esc(n).replace(/\n/g,"<br>")}</div></div>`
    : ``;

  content.innerHTML = `
    <h3>My Requests / Shifts</h3>

    <h4>Pending Requests</h4>
    ${pending.length ? pending.map(r => `
      <div class="card">
        <b>${esc(r.shifts?.title || "Shift")}</b><br>
        ${fmtDT(r.shifts?.start_time)}${r.shifts?.end_time ? ` – ${fmtDT(r.shifts.end_time)}` : ""}<br>
        ${r.shifts?.shift_where ? `<span class="pill">${esc(r.shifts.shift_where)}</span>` : ``}
        ${renderNotes(r.shifts?.notes)}
        <div style="margin-top:10px;">
          <span class="pill">Pending</span>
          <button class="secondary" style="margin-left:10px;" onclick="cancelMyPending('${r.id}')">Cancel Request</button>
        </div>
      </div>
    `).join("") : `<div class="pill">No pending requests</div>`}

    <hr>

    <h4>Approved Shifts</h4>
    ${approved.length ? approved.map(r => `
      <div class="card">
        <b>${esc(r.shifts?.title || "Shift")}</b><br>
        ${fmtDT(r.shifts?.start_time)}${r.shifts?.end_time ? ` – ${fmtDT(r.shifts.end_time)}` : ""}<br>
        ${r.shifts?.shift_where ? `<span class="pill">${esc(r.shifts.shift_where)}</span>` : ``}
        ${renderNotes(r.shifts?.notes)}
        <div style="margin-top:10px;">
          <span class="pill">Approved ✅</span>
          <button class="secondary" style="margin-left:10px;" onclick="requestRemoval('${r.id}')">Request Removal</button>
        </div>
        <div class="small" style="margin-top:6px;">Removal requires admin action.</div>
      </div>
    `).join("") : `<div class="pill">No approved shifts yet</div>`}

    <hr>

    <h4>Removal Requests</h4>
    ${removal.length ? removal.map(r => `
      <div class="card">
        <b>${esc(r.shifts?.title || "Shift")}</b><br>
        ${fmtDT(r.shifts?.start_time)}${r.shifts?.end_time ? ` – ${fmtDT(r.shifts.end_time)}` : ""}<br>
        ${r.shifts?.shift_where ? `<span class="pill">${esc(r.shifts.shift_where)}</span>` : ``}
        ${renderNotes(r.shifts?.notes)}
        <div style="margin-top:10px;">
          <span class="pill">Removal requested</span>
        </div>
      </div>
    `).join("") : `<div class="pill">No removal requests</div>`}
  `;
}

myBtn.onclick = showMyRequests;

// ===== Approvals (admin) =====
apprBtn.onclick = async () => {
  if (!IS_ADMIN) return alert("Admins only.");

  const { data: pending, error: pErr } = await supabase
    .from("shift_claims")
    .select("id,user_id,user_email,shift_id,status,created_at,shifts(id,title,start_time,end_time,shift_where,crew_size,notes)")
    .eq("status", "pending")
    .order("created_at", { ascending: false });

  if (pErr) return content.innerHTML = `<div class="error">${esc(pErr.message)}</div>`;

  const { data: removal, error: rErr } = await supabase
    .from("shift_claims")
    .select("id,user_id,user_email,shift_id,status,created_at,shifts(id,title,start_time,end_time,shift_where,crew_size,notes)")
    .eq("status", "removal_requested")
    .order("created_at", { ascending: false });

  if (rErr) return content.innerHTML = `<div class="error">${esc(rErr.message)}</div>`;

  const shiftIds = Array.from(new Set([...(pending||[]).map(x=>x.shift_id), ...(removal||[]).map(x=>x.shift_id)]));
  const approvedCounts = await getApprovedCountsForShiftIds(shiftIds);

  const notesBlock = (n) => (n && String(n).trim().length)
    ? `<div class="noteBox"><div class="noteTitle">Notes</div><div>${esc(n).replace(/\n/g,"<br>")}</div></div>`
    : ``;

  content.innerHTML = `
    <h3>Approvals</h3>

    <h4>Pending Claims</h4>
    ${(pending||[]).length ? (pending||[]).map(c => {
      const s = c.shifts || {};
      const cs = Math.max(1, Number(s.crew_size || 1));
      const ac = Number(approvedCounts[c.shift_id] || 0);
      const full = ac >= cs;

      return `
        <div class="card">
          <b>${esc(s.title || "Shift")}</b><br>
          ${fmtDT(s.start_time)}${s.end_time ? ` – ${fmtDT(s.end_time)}` : ""}<br>
          ${s.shift_where ? `<span class="pill">${esc(s.shift_where)}</span>` : ``}
          <span class="pill" style="margin-left:8px;">${slotsText(ac, cs)}</span>
          ${notesBlock(s.notes)}
          <div style="margin-top:10px;">Claimed by: <b>${esc(c.user_email || c.user_id)}</b></div>
          <div class="row" style="margin-top:10px;">
            <button ${full ? "disabled" : ""} onclick="approveClaim('${c.id}')">
              ${full ? "Full" : "Approve"}
            </button>
            <button class="secondary" onclick="denyClaim('${c.id}')">Deny</button>
          </div>
        </div>
      `;
    }).join("") : `<div class="pill">No pending claims</div>`}

    <hr>

    <h4>Removal Requests</h4>
    ${(removal||[]).length ? (removal||[]).map(c => {
      const s = c.shifts || {};
      const cs = Math.max(1, Number(s.crew_size || 1));
      const ac = Number(approvedCounts[c.shift_id] || 0);

      return `
        <div class="card">
          <b>${esc(s.title || "Shift")}</b><br>
          ${fmtDT(s.start_time)}${s.end_time ? ` – ${fmtDT(s.end_time)}` : ""}<br>
          ${s.shift_where ? `<span class="pill">${esc(s.shift_where)}</span>` : ``}
          <span class="pill" style="margin-left:8px;">${slotsText(ac, cs)}</span>
          ${notesBlock(s.notes)}
          <div style="margin-top:10px;">Employee: <b>${esc(c.user_email || c.user_id)}</b></div>
          <div class="row" style="margin-top:10px;">
            <button onclick="approveRemoval('${c.id}')">Approve Removal</button>
            <button class="secondary" onclick="denyRemoval('${c.id}')">Deny Removal</button>
          </div>
        </div>
      `;
    }).join("") : `<div class="pill">No removal requests</div>`}
  `;
};

window.approveClaim = async (claimId) => {
  const { error } = await supabase
    .from("shift_claims")
    .update({ status: "approved" })
    .eq("id", claimId);

  if (error) return alert(error.message);
  alert("Approved.");
  apprBtn.onclick();
};

window.denyClaim = async (claimId) => {
  const { error } = await supabase
    .from("shift_claims")
    .update({ status: "denied" })
    .eq("id", claimId);

  if (error) return alert(error.message);
  alert("Denied.");
  apprBtn.onclick();
};

window.approveRemoval = async (claimId) => {
  const { error } = await supabase
    .from("shift_claims")
    .update({ status: "removed" })
    .eq("id", claimId);

  if (error) return alert(error.message);
  alert("Removed from shift.");
  apprBtn.onclick();
};

window.denyRemoval = async (claimId) => {
  const { error } = await supabase
    .from("shift_claims")
    .update({ status: "approved" })
    .eq("id", claimId);

  if (error) return alert(error.message);
  alert("Removal denied (kept approved).");
  apprBtn.onclick();
};

// ===== Admin: Manage shift (remove member) / Delete shift =====
window.manageShift = async (shiftId) => {
  if (!IS_ADMIN) return alert("Admins only.");

  const { data: shift, error: sErr } = await supabase
    .from("shifts")
    .select("*")
    .eq("id", shiftId)
    .single();
  if (sErr) return alert(sErr.message);

  const { data: approved, error: aErr } = await supabase
    .from("shift_claims")
    .select("id,user_id,user_email,status")
    .eq("shift_id", shiftId)
    .eq("status", "approved")
    .order("created_at", { ascending: true });

  if (aErr) return alert(aErr.message);

  const cs = Math.max(1, Number(shift.crew_size || 1));
  const ac = (approved || []).length;

  const notesHtml = (shift.notes && String(shift.notes).trim().length)
    ? `<div class="noteBox"><div class="noteTitle">Notes</div><div>${esc(shift.notes).replace(/\n/g,"<br>")}</div></div>`
    : ``;

  content.innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin:0;">Manage Shift</h3>
      <div class="row">
        <button class="secondary" onclick="showSchedule()">Back</button>
        <button class="danger" onclick="deleteShift('${shiftId}')">Delete Shift</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <b>${esc(shift.title)}</b><br>
      ${fmtDT(shift.start_time)}${shift.end_time ? ` – ${fmtDT(shift.end_time)}` : ""}<br>
      ${shift.shift_where ? `<span class="pill">${esc(shift.shift_where)}</span>` : ``}
      <span class="pill" style="margin-left:8px;">${slotsText(ac, cs)}</span>
      ${notesHtml}
      <div class="small" style="margin-top:8px;">Remove an employee to free a slot.</div>
    </div>

    <h4>Approved Members</h4>
    ${(approved || []).length ? (approved || []).map(m => `
      <div class="card">
        <div><b>${esc(m.user_email || m.user_id)}</b></div>
        <div class="row" style="margin-top:10px;">
          <button class="danger" onclick="adminRemoveApproved('${m.id}')">Remove</button>
        </div>
      </div>
    `).join("") : `<div class="pill">No approved members yet</div>`}
  `;
};

window.adminRemoveApproved = async (claimId) => {
  if (!IS_ADMIN) return alert("Admins only.");

  const { error } = await supabase
    .from("shift_claims")
    .update({ status: "removed" })
    .eq("id", claimId);

  if (error) return alert(error.message);
  alert("Removed.");
  await showSchedule();
};

window.deleteShift = async (shiftId) => {
  if (!IS_ADMIN) return alert("Admins only.");
  if (!confirm("DELETE SHIFT?\n\nThis permanently removes the shift and all claims.\nThis cannot be undone.")) return;

  const { error: e1 } = await supabase.from("shift_claims").delete().eq("shift_id", shiftId);
  if (e1) return alert("Delete claims failed: " + e1.message);

  const { data: deletedShift, error: e2 } = await supabase
    .from("shifts")
    .delete()
    .eq("id", shiftId)
    .select("id");

  if (e2) return alert("Delete shift failed: " + e2.message);

  if (!deletedShift || deletedShift.length === 0) {
    alert("Delete blocked (no rows deleted). This is almost always an RLS/policy issue.");
    return;
  }

  alert("Shift deleted.");
  await showSchedule();
};

// ===== Calendar (weekly) =====
async function showCalendarWeek(weekOffset = 0) {
  const base = startOfWeek(new Date());
  const weekStart = addDays(base, weekOffset * 7);
  const weekEnd = addDays(weekStart, 7);

  content.innerHTML = `
    <div class="row" style="justify-content:space-between; margin-top:10px;">
      <h3 style="margin:0;">Weekly Calendar</h3>
      <div class="row">
        <button class="secondary" id="prevWeekBtn">◀ Prev</button>
        <button class="secondary" id="thisWeekBtn">This Week</button>
        <button class="secondary" id="nextWeekBtn">Next ▶</button>
      </div>
    </div>

    <div class="pill" style="margin-top:10px;">
      ${fmtDay(weekStart)} – ${fmtDay(addDays(weekStart, 6))}
    </div>

    <div id="calGrid" style="
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    "></div>

    <div id="calErr" class="error"></div>
  `;

  prevWeekBtn.onclick = () => showCalendarWeek(weekOffset - 1);
  nextWeekBtn.onclick = () => showCalendarWeek(weekOffset + 1);
  thisWeekBtn.onclick = () => showCalendarWeek(0);

  const calGrid = document.getElementById("calGrid");
  const calErr = document.getElementById("calErr");

  const { data, error } = await supabase
    .from("shifts")
    .select("*")
    .gte("start_time", weekStart.toISOString())
    .lt("start_time", weekEnd.toISOString())
    .order("start_time", { ascending: true });

  if (error) {
    calErr.textContent = error.message;
    return;
  }

  const shifts = data || [];
  const shiftIds = shifts.map(s => s.id);
  const approvedCounts = await getApprovedCountsForShiftIds(shiftIds);
  const myStatus = await getMyClaimStatusMapForShiftIds(shiftIds);

  const days = Array.from({ length: 7 }, (_, i) => addDays(weekStart, i));

  days.forEach((dayDate, i) => {
    const col = document.createElement("div");
    col.className = "card";
    col.style.boxShadow = "none";
    col.style.border = "1px solid #ddd";
    col.style.padding = "14px";

    const dayStart = new Date(dayDate); dayStart.setHours(0,0,0,0);
    const dayEnd = new Date(dayDate); dayEnd.setHours(23,59,59,999);

    const dayShifts = shifts.filter(s => {
      const st = new Date(s.start_time);
      return st >= dayStart && st <= dayEnd;
    });

    col.innerHTML = `
      <div style="font-weight:900; margin-bottom:8px;">${fmtDay(dayDate)}</div>
      <div id="day_${i}" style="display:grid; gap:8px;"></div>
      ${dayShifts.length === 0 ? `<div class="pill" style="margin-top:8px;">No shifts</div>` : ``}
    `;

    calGrid.appendChild(col);

    const dayWrap = col.querySelector(`#day_${i}`);
    dayShifts.forEach(s => {
      const st = new Date(s.start_time);
      const en = s.end_time ? new Date(s.end_time) : null;

      const cs = Math.max(1, Number(s.crew_size || 1));
      const ac = Number(approvedCounts[s.id] || 0);
      const full = ac >= cs;

      const mine = myStatus[s.id];
      let actionHtml = "";
      if (full) actionHtml = `<span class="pill">Filled</span>`;
      else if (mine === "pending") actionHtml = `<span class="pill">Pending</span>`;
      else if (mine === "approved") actionHtml = `<span class="pill">Approved</span>`;
      else if (mine === "removal_requested") actionHtml = `<span class="pill">Removal req.</span>`;
      else actionHtml = `<button onclick="claimShift('${s.id}')">Claim</button>`;

      const notesHtml = (s.notes && String(s.notes).trim().length)
        ? `<div class="noteBox" style="margin-top:8px;"><div class="noteTitle">Notes</div><div>${esc(s.notes).replace(/\n/g,"<br>")}</div></div>`
        : ``;

      const block = document.createElement("div");
      block.style.border = "1px solid #ddd";
      block.style.borderRadius = "10px";
      block.style.padding = "10px";
      block.style.background = "#fff";

      block.innerHTML = `
        <div style="font-weight:800;">${esc(s.title)}</div>
        <div style="color:#444; margin-top:4px;">
          ${fmtTime(st)}${en ? ` – ${fmtTime(en)}` : ``}
        </div>
        ${s.shift_where ? `<div class="small" style="margin-top:2px;">${esc(s.shift_where)}</div>` : ``}
        <div style="margin-top:8px;">
          <span class="pill">${slotsText(ac, cs)}</span>
          <div style="margin-top:8px;">${actionHtml}</div>
        </div>
        ${notesHtml}
      `;

      dayWrap.appendChild(block);
    });
  });

  if (window.innerWidth < 850) {
    calGrid.style.gridTemplateColumns = "1fr";
  }
}

// ===== Announcements =====
annBtn.onclick = () => {
  content.innerHTML = `
    <h3>Announcements</h3>
    <div class="pill" style="margin-top:12px;">No announcements yet</div>
  `;
};

// ===== Nav wiring =====
schedBtn.onclick = showSchedule;
calBtn.onclick = () => showCalendarWeek(0);

// ===== Auto login =====
const user = await getUser();
if (user) await showPortal(user);
</script>

</body>
</html>
